<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>分组管理</title>
    <script src="../../common/jquery/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="../../common/jquery/jquery-ui.css">
    <script src="../../common/jquery/jquery-ui.js"></script>
    <script src="../../common/mytools/myTools.js"></script>
    <link rel="stylesheet" href="../../common/bootstrap/css/bootstrap.css">
    <script src="../../common/bootstrap/js/bootstrap.js"></script>
    <link rel="stylesheet" href="../../common/jstree/themes/default/style.min.css">
    <script src="../../common/jstree/jstree.js"></script>
    <script src="../../system/divTree/divTree.js"></script>
    <link rel="stylesheet" href="../../common/global.css">
</head>
<body>
<div class="container">
    <div class="col-md-4">
        <div class="container-fluid">
            <div class="form-group col-md-7">
                <input id="input-search" type="text" class="form-control  form-inline input-sm ">
            </div>
        </div>

        <div class="btn-group ">
            <button id="btn-add" class="btn btn-default btn-sm">新增</button>
            <button id="btn-modify" class="btn btn-default btn-sm">修改</button>
            <button id="btn-del" class="btn btn-default btn-sm">删除</button>
            <button id="btn-save" class="btn btn-default btn-sm">保存</button>
        </div>

        <div class="">
            <div id="divTree" class=""></div>
        </div>
    </div>
    <div class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><div class="modal-title">分组信息<button class="close" data-dismiss="modal">&times;</button></div> </div>
                <div class="modal-body">
                    <form action="" id="form-dialog" class="form-inline">
                        <div class="form-group">
                            <label for="groupCode" class="control-label">分组编码：</label>
                            <input id="groupCode" type="text" name="groupCode" class="form-control input-sm">
                        </div>
                        <div class="form-group">
                            <label for="text" class="control-label">分组名称：</label>
                            <input id="text" type="text" name="text" class="form-control input-sm">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal">取消</button>
                    <button id="btn_ok" class="btn btn-default">确定</button>
                </div>
            </div>
        </div>
    </div>

</div>


</body>
<script>
    var tree = $("#divTree");
    tree.divTree({"admin": true});
    tree.divTree("refresh");
    var inputSearch = $("#input-search");
    inputSearch.keydown(function () {
        setTimeout(function () {
            tree.jstree(true).search(inputSearch.val());
        }, 100)
    });

    var modal = $(".modal");
    modal.modal("hide");
    var mode = 0;
    $("#btn-add").click(function () {
        mode = 0;
        clearData(modal);
        modal.modal();
    });
    $("#btn-modify").click(function () {
        mode = 1;
        var selId = tree.jstree(true).get_selected()[0];
        var selData = tree.jstree()._model.data[selId].original;
        if(!selData){
            alert("请先选择一条数据再修改!");
            return;
        }
        setData(modal,selData);
        modal.modal();
    });
    $("#btn-del").click(function () {
        tree.jstree(true).delete_node(tree.jstree(true).get_selected()[0]);
    });

    $("#btn-save").click(function () {
        var data = tree.divTree("getData");
        $.ajax({
            url:$.fn.baseURL+"/usermanger/saveGroup.do",
            data:{data:JSON.stringify(data)},
            type:"POST",
            async:true,
            success:function (data) {
                alert("保存成功!");
            }
        });
    });

    modal.on("show.bs.modal",function () {
    });

    /**
     * 对话框
     */
    modal.find("#btn_ok").click(function () {
        var formdialg = modal.find("#form-dialog");
        var data = {groupCode:formdialg.find("[name=groupCode]").val(),text:formdialg.find("[name=text]").val(),id:$.fn.uuid()};
        if(mode == 0){
            tree.jstree(true).create_node(tree.jstree(true).get_selected()[0],data)
        }else if(mode == 1){
            var selId = tree.jstree(true).get_selected()[0];
            var dataSel = tree.jstree()._model.data[selId];
            var original= dataSel.original;
            tree.jstree(true).rename_node(selId,data.text);
            original.groupCode = data.groupCode;
        }
        modal.modal("hide");
    });

    function clearData(ele) {
        ele.find("[name]").val(null);
    }

    function setData(ele,data){
        ele.find("[name]").each(function (i,v) {
            $(v).val(data[$(v).attr("name")]);
        });
    }


</script>
</html>